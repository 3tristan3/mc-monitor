<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MC 服务器状态监控</title>
    <!-- 引入 Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入图标库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- 引入 Google Fonts (英文字体) -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-purple: #6f42c1;
            --primary-gradient: linear-gradient(135deg, #a4508b 0%, #5f2c82 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
        }

        body {
            background: url("{{ url_for('static', filename='images/bg.jpg') }}") no-repeat center center fixed;
            background-size: cover;
            font-family: 'Nunito', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            padding-top: 40px;
            padding-bottom: 40px;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(30, 10, 50, 0.3);
            z-index: -1;
            backdrop-filter: blur(3px);
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            padding: 50px 40px;
            overflow: hidden;
            position: relative;
        }

        .glass-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 6px;
            background: var(--primary-gradient);
        }

        h1.title { color: #2d1b4e; font-weight: 800; letter-spacing: -1px; }
        p.subtitle { color: #6c757d; font-weight: 500; }

        .btn-purple-gradient {
            background: var(--primary-gradient);
            border: none; color: white; padding: 12px 35px; border-radius: 50px;
            font-weight: 700; box-shadow: 0 4px 15px rgba(111, 66, 193, 0.4);
            transition: all 0.3s ease; white-space: nowrap;
        }

        .btn-purple-gradient:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 20px rgba(111, 66, 193, 0.6);
            color: white;
        }
        
        /* 让下载按钮也应用渐变色 */
        #download-btn {
            padding: 0.375rem 1rem; /* 匹配sm按钮的大小 */
            font-size: .875rem; /* 匹配sm按钮的大小 */
        }

        .custom-input-group {
            background: white; padding: 8px; border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid rgba(111, 66, 193, 0.1);
            display: flex; align-items: center;
        }

        .custom-input { border: none; box-shadow: none; padding-left: 15px; font-size: 1.05rem; color: #495057; }
        .custom-input:focus { box-shadow: none; background: transparent; }
        .input-icon { color: var(--primary-purple); padding-left: 15px; font-size: 1.2rem; }

        #result-area { margin-top: 40px; display: none; animation: slideDown 0.4s ease-out; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(111, 66, 193, 0.1);
            border-radius: 16px; padding: 20px; text-align: center;
            transition: transform 0.2s; height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px); background: white;
            box-shadow: 0 10px 20px rgba(111, 66, 193, 0.1);
        }

        .stat-icon { font-size: 1.5rem; color: var(--primary-purple); margin-bottom: 10px; opacity: 0.8; }
        .stat-value { font-size: 1.25rem; font-weight: 800; color: #2d1b4e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stat-label { font-size: 0.85rem; color: #888; letter-spacing: 1px; margin-top: 5px; }

        .motd-box {
            background: #1e1e24; color: #eee; border-radius: 12px; padding: 20px;
            font-family: 'Consolas', 'Courier New', monospace; margin-top: 20px;
            border-left: 4px solid var(--primary-purple); line-height: 1.5;
            white-space: pre-wrap; /* 保证MOTD可以换行 */
        }
        
        .player-list-box {
            background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(111, 66, 193, 0.1);
            border-radius: 16px; padding: 20px; margin-top: 20px;
        }
        .player-list-box .list-group-item {
            background-color: transparent;
            border-color: rgba(111, 66, 193, 0.15);
            color: #2d1b4e;
        }

        .type-selector .btn-check:checked+.btn-outline-primary {
            background: var(--primary-gradient);
            border-color: var(--primary-purple);
            color: white;
        }
        .type-selector .btn-outline-primary {
            border-color: rgba(111, 66, 193, 0.4);
            color: var(--primary-purple);
            border-radius: 50px !important; /* 强制圆角 */
        }
        .type-selector .btn-outline-primary:hover {
            background-color: rgba(111, 66, 193, 0.1);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            
            <div class="glass-card">
                <div class="text-center mb-5">
                    <h1 class="title">MC 服务器状态监控</h1>
                    <p class="subtitle">输入服务器地址，实时查看在线人数与版本信息</p>
                </div>

                <!-- 输入区域 -->
                <form id="query-form">
                    <div class="custom-input-group mb-3">
                        <i class="bi bi-controller input-icon"></i>
                        <input type="text" id="server-ip" class="form-control custom-input" 
                               placeholder="请输入服务器地址 (例如: play.hypixel.net)" required>
                        <button class="btn btn-purple-gradient" type="submit">
                            立即查询
                        </button>
                    </div>
                </form>

                <!-- 服务器类型切换 -->
                <div class="btn-group w-100 type-selector mb-4" role="group">
                    <input type="radio" class="btn-check" name="server-type" id="type-java" value="java" autocomplete="off" checked>
                    <label class="btn btn-outline-primary mx-1" for="type-java"><i class="bi bi-cup-hot me-2"></i>Java 版</label>
                
                    <input type="radio" class="btn-check" name="server-type" id="type-bedrock" value="bedrock" autocomplete="off">
                    <label class="btn btn-outline-primary mx-1" for="type-bedrock"><i class="bi bi-phone me-2"></i>基岩版</label>
                </div>
                
                <!-- 加载动画 -->
                <div id="loader" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status" style="color: var(--primary-purple) !important;"></div>
                    <div class="mt-2 text-muted small">正在连接服务器...</div>
                </div>

                <!-- 错误提示 -->
                <div id="error-msg" class="alert alert-danger mt-4" style="display: none; border-radius: 12px;"></div>

                <!-- 结果展示 -->
                <div id="result-area">
                    <div class="row g-3">
                        <!-- 状态 -->
                        <div class="col-6 col-md-4">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="bi bi-activity"></i></div>
                                <div id="res-status" class="stat-value">-</div>
                                <div class="stat-label">服务器状态</div>
                            </div>
                        </div>
                        <!-- 版本 -->
                        <div class="col-6 col-md-4">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="bi bi-box-seam"></i></div>
                                <div class="stat-value" id="res-version">-</div>
                                <div class="stat-label">游戏版本</div>
                            </div>
                        </div>
                        <!-- 人数 -->
                        <div class="col-12 col-md-4">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                                <div class="stat-value" id="res-players">-</div>
                                <div class="stat-label">在线人数</div>
                            </div>
                        </div>
                    </div>

                    <div class="motd-box mt-4" id="res-motd"></div>

                    <!-- 玩家列表展示区 -->
                    <div class="player-list-box mt-4" id="player-list-area" style="display: none;">
                        <h5 class="mb-3" style="color: #2d1b4e; font-weight: 700;">
                            <i class="bi bi-person-check-fill me-2"></i>在线玩家
                        </h5>
                        <div id="res-player-list"></div>
                    </div>
                    
                    <!-- 【修改】按钮区域 -->
                    <div class="text-center mt-4">
                        <button class="btn btn-sm btn-outline-secondary rounded-pill px-4" onclick="resetForm()">清除结果</button>
                        <!-- 【新增】下载图片按钮 -->
                        <button id="download-btn" class="btn btn-sm btn-purple-gradient rounded-pill px-4" style="display: none;">
                            <i class="bi bi-camera-fill me-1"></i> 下载为图片
                        </button>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>

<script>
    function renderMotd(motdString) {
        if (!motdString) return '<span style="color: #888;">(服务器未提供欢迎信息)</span>';
        
        const colorMap = {
            '0': '#000000', '1': '#0000AA', '2': '#00AA00', '3': '#00AAAA',
            '4': '#AA0000', '5': '#AA00AA', '6': '#FFAA00', '7': '#AAAAAA',
            '8': '#555555', '9': '#5555FF', 'a': '#55FF55', 'b': '#55FFFF',
            'c': '#FF5555', 'd': '#FF55FF', 'e': '#FFFF55', 'f': '#FFFFFF'
        };
        const formatMap = {
            'l': 'font-weight: bold;', 'm': 'text-decoration: line-through;',
            'n': 'text-decoration: underline;', 'o': 'font-style: italic;',
        };

        let currentStyle = '';
        let html = '';
        const parts = motdString.split('§');

        const firstPart = parts.shift().replace(/\n/g, '<br>');
        html += `<span>${firstPart}</span>`;

        parts.forEach(part => {
            const code = part.charAt(0);
            let text = part.substring(1);
            
            if (colorMap[code]) {
                currentStyle = `color: ${colorMap[code]};`;
            } else if (formatMap[code]) {
                currentStyle += formatMap[code];
            } else if (code === 'r' || code === '') {
                currentStyle = '';
            }
            
            if (text) {
                html += `<span style="${currentStyle}">${text.replace(/\n/g, '<br>')}</span>`;
            }
        });

        return html;
    }

    // 【修改】添加隐藏下载按钮的逻辑
    function resetForm() {
        document.getElementById('server-ip').value = '';
        document.getElementById('result-area').style.display = 'none';
        document.getElementById('error-msg').style.display = 'none';
        document.getElementById('player-list-area').style.display = 'none';
        document.getElementById('download-btn').style.display = 'none'; // 新增
    }

    async function queryServer(event) {
        if(event) event.preventDefault();

        const ip = document.getElementById('server-ip').value.trim();
        const serverType = document.querySelector('input[name="server-type"]:checked').value;
        const resultArea = document.getElementById('result-area');
        const loader = document.getElementById('loader');
        const errorMsg = document.getElementById('error-msg');
        const playerListArea = document.getElementById('player-list-area');

        if (!ip) {
            alert("请输入服务器地址！");
            return;
        }

        resultArea.style.display = 'none';
        errorMsg.style.display = 'none';
        playerListArea.style.display = 'none';
        document.getElementById('download-btn').style.display = 'none'; // 查询前先隐藏旧按钮
        loader.style.display = 'block';

        try {
            const response = await fetch(`/query?ip=${encodeURIComponent(ip)}&type=${serverType}`);
            const data = await response.json();

            loader.style.display = 'none';

            if (!data.online || data.error) {
                const errorMessage = data.error ? `查询失败: ${data.error}` : '服务器当前离线或地址不正确。';
                document.getElementById('res-status').innerHTML = '<span class="text-danger">离线</span>';
                document.getElementById('res-version').innerText = '-';
                document.getElementById('res-players').innerText = '-';
                document.getElementById('res-motd').innerHTML = `<span style="color: #888;">(${errorMessage})</span>`;
                resultArea.style.display = 'block';
            } else {
                resultArea.style.display = 'block';
                document.getElementById('download-btn').style.display = 'inline-block'; // 【修改】查询成功后显示下载按钮
                document.getElementById('res-status').innerHTML = '<span class="text-success">在线</span>';
                document.getElementById('res-version').innerText = data.version;
                document.getElementById('res-version').title = data.version; 
                document.getElementById('res-players').innerText = `${data.online_players} / ${data.max_players}`;
                document.getElementById('res-motd').innerHTML = renderMotd(data.motd);

                const playerListEl = document.getElementById('res-player-list');
                if (data.players_sample && data.players_sample.length > 0) {
                    let playerHtml = '<ul class="list-group list-group-flush">';
                    data.players_sample.forEach(player => {
                        playerHtml += `<li class="list-group-item">${player.name}</li>`;
                    });
                    playerHtml += '</ul>';
                    playerListEl.innerHTML = playerHtml;
                    playerListArea.style.display = 'block';
                } else {
                    playerListArea.style.display = 'none';
                }
            }
        } catch (e) {
            loader.style.display = 'none';
            errorMsg.style.display = 'block';
            errorMsg.innerText = `请求失败: ${e.message}。请检查网络或联系管理员。`;
        }
    }
    
    document.getElementById('query-form').addEventListener('submit', queryServer);


    // 【全新功能】处理图片下载的完整逻辑
    document.addEventListener('DOMContentLoaded', () => {
        const downloadButton = document.getElementById('download-btn');
    
        downloadButton.addEventListener('click', async () => {
    
            // 1. 从页面上实时提取需要展示的数据
            const serverIp = document.getElementById('server-ip').value;
            const statusText = document.getElementById('res-status').innerText;
            const versionText = document.getElementById('res-version').innerText;
            const playersText = document.getElementById('res-players').innerText;
            
            const params = new URLSearchParams({
                serverName: serverIp || "我的服务器",
                status: statusText,
                version: versionText,
                players: playersText,
            });
    
            // 2. 构建 API URL
            const apiUrl = `/api/og?${params.toString()}`;
    
            try {
                // 3. 更改按钮状态，提供用户反馈
                downloadButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 生成中...';
                downloadButton.disabled = true;
    
                // 4. 调用 API 获取图片
                const response = await fetch(apiUrl);
    
                if (!response.ok) {
                    throw new Error(`图片生成失败，状态码: ${response.status}`);
                }
    
                // 5. 将响应体转换为 Blob (图片的二进制数据)
                const imageBlob = await response.blob();
    
                // 6. 创建临时 URL 指向图片数据
                const imageUrl = URL.createObjectURL(imageBlob);
    
                // 7. 创建隐藏的 <a> 标签来触发下载
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = `${serverIp || 'server'}-status.png`; // 使用服务器IP作为文件名
                document.body.appendChild(link);
                link.click();
    
                // 8. 清理工作
                document.body.removeChild(link);
                URL.revokeObjectURL(imageUrl);
    
            } catch (error) {
                console.error('下载图片时出错:', error);
                alert('无法生成图片，请查看浏览器控制台 (F12) 获取更多信息。');
            } finally {
                // 9. 恢复按钮原始状态
                downloadButton.innerHTML = '<i class="bi bi-camera-fill me-1"></i> 下载为图片';
                downloadButton.disabled = false;
            }
        });
    });
</script>

</body>
</html>